!function(a,b){if("function"==typeof define&&define.amd)b(define);else{var c="sub-sync",d={};if(!a.coop)throw new Error(c+": Missing dependency: coop");d.coop=a.coop,b(function(a,b,c){for(var e=a.slice(0,a.lastIndexOf("/")+1),f=0;f<b.length;f++){var g=b[f];"."==g[0]&&(g="./"+e+g.slice(2));var h=d[g];if(!h)throw new Error(a+": undefined module - "+g);b[f]=h}d["./"+a]=c.apply(this,b)}),a.subSync=d["./sub-sync"]}}(this,function(a){a("lib/subscribable",["coop"],function(a){var b=new a.Class({subscribe:function(){return this.createSubscription()},createSubscription:function(){return function(){return this.getAll()}}});return b}),a("lib/extractor",["coop"],function(a){var b=new a.Class({extract:function(a,b){return b[a]}});return b}),a("lib/filter",["coop","./extractor"],function(a,b){function c(a,b){return a==b}function d(a){return"eq"==a.name?c(this.value,a.value):"neq"==a.name?!1:void 0}function e(a){return/[lg]t(e)?/.test(a.name)?!1:void 0}function f(a,b){return b.indexOf(a)>=0}function g(a){return"eq"==a.name?f(a.value,this.value):"in"==a.name?a.value.every(function(a){return f(a,this.value)},this):void 0}function h(a){return this.value.length?"eq"==a.name?1===this.value.length&&c(this.value[0],a.value):"neq"==a.name?!f(a.value,this.value):"nin"==a.name?!a.value.some(function(a){return f(a,this.value)},this):void 0:!0}var i=new a.Class([b],{__isFilter:!0,initialize:function(a,b){this.key=a,this.value=b},inverse:function(){return new i.filters[this.inverseName](this.key,this.value)},valueFrom:function(a,b){return(b||this).extract(this.key,a)},equals:function(a){return this.includes(a)&&this.includedIn(a)},includes:function(a,b){if(this._includes&&a.__isFilter){if(this.key!==a.key)return i.UNKNOWN;var c=this._includes(a);if(c||c===!1)return c}return b?void 0:a.includedIn(this,!0)},includedIn:function(a,b){if(this._includedIn&&a.__isFilter){if(this.key!==a.key)return i.UNKNOWN;var c=this._includedIn(a);if(c||c===!1)return c}return b?void 0:a.includes(this,!0)},toJSON:function(){return[this.key,this.name,this.value]},toString:function(){return this.key+" "+this.name+" "+this.value}});return i.filters={},i.fromJSON=function(a){if(a instanceof Array)for(var b in i.filters)if(a[1]==b&&i.filters.hasOwnProperty(b))return new i.filters[b](a[0],a[2])},i.Inverse=i.derived({isInverse:!0,_includes:function(a){return this.inverse()._includedIn(a.inverse())},_includedIn:function(a){return this.inverse()._includes(a.inverse())}}),i.define=function(a,b,c,d,e){e=e||"n"+a,this.filters[a]=i.derived({name:a,inverseName:e,matches:function(a,c){return b(this.valueFrom(a,c),this.value,this.key)},_includes:c,_includedIn:d}),this.filters[e]=i.Inverse.derived({name:e,inverseName:a,matches:function(a,c){return!b(this.valueFrom(a,c),this.value,this.key)}})},i.define("eq",c,d,function(a){return"neq"==a.name?!c(this.value,a.value):d.call(this,a)}),i.define("lt",function(a,b){return b>a},function(a){return"lt"==a.name?this.value>=a.value:"lte"==a.name?this.value>a.value:e(a)},function(a){return 0===a.name.lastIndexOf("lt",0)?this.value<=a.value:e(a)},"gte"),i.define("gt",function(a,b){return a>b},function(a){return"gt"==a.name?this.value<=a.value:"gte"==a.name?this.value<a.value:e(a)},function(a){return 0===a.name.lastIndexOf("gt",0)?this.value>=a.value:e(a)},"lte"),i.define("in",f,g,h),i.Filterable=new a.Class({filter:function(a,b,c){if(void 0===c&&(c=b,b="eq"),!(b in i.filters))throw new Error("Unknown operator: "+b);return this.withFilter(new i.filters[b](a,c))}}),i}),a("lib/subscriptionSpec",["coop","./subscribable","./filter"],function(a,b,c){var d=new a.Class([b,c.Filterable],{initialize:function(a,b){this.resource=a,this.spec=b},equals:function(a){return this.includes(a)&&this.includedIn(a)},all:function(){return this},or:function(a){return new d.Disjunction(this.resource,[this,a(this.resource)])},not:function(a){return this.withFilter(a(this).inverse())},getAll:function(){return this.resource.getAll().filter(this.matches,this)},subscribe:function(){var a=this.super.apply(this,arguments);return a.filter=this,this.resource.addSubscription(this),a.dispose=function(){this.filter.resource.removeSubscription(this.filter)},a.refresh=function(){return this.filter.resource.refresh()},a},toJSON:function(){return this.spec.map(function(a){return a.toJSON()})}});return d.fromJSONHandlers=[],d.fromJSON=function(a,b){var e=c.fromJSON(b);if(e)return new d.Filters(a,[e]);for(var f=0;f<this.fromJSONHandlers.length;f++)if(e=this.fromJSONHandlers[f](a,b))return e;throw new Error("Failed to parse SubscriptionSpec - no handler found: "+JSON.stringify(b))},d.Disjunction=new a.Class([d],{or:function(a){return this.union(a(this.resource))},union:function(a){var b;return b=d.Disjunction.isinstance(a)?a.spec:[a],new d.Disjunction(this.resource,this.spec.concat(b))},getAll:function(){return this.resource.getAll().filter(this.matches,this)},matches:function(a){return this.spec.some(function(b){return b.matches(a,this.resource)},this)},withFilter:function(a){return new d.Disjunction(this.resource,this.spec.map(function(b){return b.withFilter(a,this.resource)},this))},inverse:function(){for(var a=this.spec[0].inverse(),b=1;b<this.spec.length;b++)console.log(a.toString()),a=a.withFilter(this.spec[b].inverse());return a},includes:function(a,b){return this.spec.some(function(b){return b.includes(a)})?!0:b?void 0:a.includedIn(this,!0)},includedIn:function(a,b){return this.spec.every(function(b){return b.includedIn(a)})?!0:b?void 0:a.includes(this,!0)},isEmpty:function(){return 0==this.spec.length},toJSON:function(){return 1==this.spec.length?this.spec[0].toJSON():{any:this.super()}},toString:function(){return this.spec.map(function(a){return"( "+a.toString()+" )"}).join(" || ")}}),d.Disjunction.build=function(a,b,c){var e=new d.Disjunction(a,[]);return b.forEach(function(a){c&&e.includes(a)||(e=e.or(a))}),e},d.fromJSONHandlers.push(function(a,b){return b.any?new d.Disjunction(a,b.any.map(function(b){return d.fromJSON(a,b)})):void 0}),d.Filters=new a.Class([d],{matches:function(a){return this.spec.every(function(b){return b.matches(a,this.resource)},this)},union:function(a){return new d.Disjunction(this.resource,[this,a])},withFilter:function(a){return new d.Filters(this.resource,this.spec.concat([a]))},inverse:function(){return new d.Disjunction(this.resource,this.spec.map(function(a){return new d.Filters(this.resource,[a.inverse()])},this))},includes:function(a,b){return this.spec.every(function(b){return b.includes(a)})?!0:b?void 0:a.includedIn(this,!0)},includedIn:function(a,b){return this.spec.some(function(b){return b.includedIn(a)})?!0:b?void 0:a.includes(this,!0)},toJSON:function(){return 1==this.spec.length?this.spec[0].toJSON():{all:this.super()}},toString:function(){return this.spec.length?this.spec.map(function(a){return a.toString()}).join(" && "):"*"}}),d.fromJSONHandlers.push(function(a,b){return b.all?new d.Filters(a,b.all.map(function(b){return d.fromJSON(a,b)})):void 0}),c.implement({withFilter:function(a,b){if(void 0===b)throw Error("Filter.withFilter: Resource not defined");return new d.Filters(b,[this,a])}}),d.Decorator=d.derived({matches:function(a){return this.spec.matches(a)},union:function(a){return this.decorate(this.spec.union(a))},withFilter:function(a){return this.decorate(this.spec.withFilter(a))},inverse:function(){return this.decorate(this.spec.inverse())},includes:function(a,b){return this.spec.includes(a,b)},includedIn:function(a,b){return this.spec.includedIn(a,b)}}),d}),a("lib/resource",["coop","./subscribable","./filter","./subscriptionSpec","./extractor"],function(a,b,c,d,e){var f=new a.Class([a.Options,e,b,c.Filterable],{options:{id:function(a){return a.id},ctor:function(a){return this.options.ViewModel?new this.options.ViewModel(a,this):a},update:function(a,b){return this.options.ViewModel?a.update(b)||a:b}},initialize:function(){this.super.apply(this,arguments),this.subscription=new d.Disjunction(this,[]),this.subscriptions=[],this.objects={},this.listeners=[],f.listeners.forEach(function(a){a(this)},this);var a=this.options.id;this.id="function"==typeof a?a:function(b){return b[a]}},all:function(){return new d.Filters(this,[])},subscribe:function(){return this.all().subscribe()},addSubscription:function(a){return this.subscriptions.push(a),this.subscription.includes(a)?void 0:(this.subscription=this.subscription.union(a),this.refresh())},removeSubscription:function(a){var b=this.subscriptions.indexOf(a);if(!(0>b))return this.subscriptions.splice(b,1),this.subscription=d.Disjunction.build(this,this.subscriptions,!0),this.refresh()},refresh:function(){},getAll:function(){return Object.keys(this.objects).map(function(a){return this.objects[a]},this)},get:function(a){return a in this.objects?this.objects[a]:null},setAll:function(a){var b=0,c=0,d=0,e=0;return a.forEach(function(a){var c=this.id(a);if(c in this.objects){var f=this.objects[c],g=this.options.update.call(this,f,a);f!==g?(this.objects[c]=g,d++):e++}else this.objects[c]=this.options.ctor.call(this,a),b++},this),a.length<Object.keys(this.objects).length,b&&this.listeners.forEach(function(a){a.onObjectsAdded()}),(c||d)&&this.listeners.forEach(function(a){a.onObjectsRemoved()}),{numAdded:b,numChanged:d,numRemoved:c,numUpdated:e}},withFilter:function(a){return new d.Filters(this,[a])}});return f.listeners=[],f}),a("lib/sort",["coop","./subscribable","./filter","./subscriptionSpec","./extractor"],function(a,b,c,d,e){var f=new a.Class([e],{compare:function(a,b,c){var d=this.valueFrom(a,c),e=this.valueFrom(b,c);return e>d?-1:d>e?1:0}});return f.fromJSONHandlers=[],f.fromJSON=function(a){for(var b=0;b<this.fromJSONHandlers.length;b++){var c=this.fromJSONHandlers[b](a);if(c)return c}},f.ByCol=f.derived({initialize:function(a){this.col=a},valueFrom:function(a,b){return(b||this).extract(this.col,a)},toJSON:function(){return{col:this.col}},toString:function(){return this.col}}),f.SortedSubscription=d.Decorator.derived({initialize:function(a){this.super_co(arguments,1),this.sort=a},getAll:function(){var a=this.resource,b=this.sort;return this.spec.getAll().slice(0).sort(function(c,d){return b.compare(c,d,a)})},toJSON:function(){return{sort:this.sort.toJSON(),values:this.spec.toJSON()}},decorate:function(a){return new f.SortedSubscription(this.sort,this.resource,a)},toString:function(){return"[ sort "+this.sort.toString()+" ]{ "+this.spec.toString()+" }"}}),d.fromJSONHandlers.push(function(a,b){if(b.sort){var c=f.fromJSON(b.sort),e=d.fromJSON(a,b.values);return c?new f.SortedSubscription(c,a,e):(console.log("Sort not supported:",b.sort),e)}}),d.implement({sort:function(a){f.isinstance(a)||(a=new f.ByCol(a));var b=f.SortedSubscription.isinstance(this)?this.spec:this;return new f.SortedSubscription(a,this.resource,b)}}),f}),a("lib/paginator",["coop","./subscribable","./filter","./subscriptionSpec"],function(a,b,c,d){var e=new a.Class({initialize:function(a,b){this.start=a,this.end=b},paginate:function(a){return a.slice(this.start,this.end)},includes:function(a){return this.start>=a.start&&this.end>=a.end},includedIn:function(a){return a.includes(this,!0)},toJSON:function(){return{start:this.start,end:this.end}}});return e.fromJSON=function(a){return"start"in a&&"end"in a?new e(a.start,a.end):void 0},e.PaginatedSubscription=d.Decorator.derived({initialize:function(a){this.super_co(arguments,1),this.paginator=a},getAll:function(){return this.paginator.paginate(this.spec.getAll())},toJSON:function(){return{paginate:this.paginator.toJSON(),values:this.spec.toJSON()}},includes:function(a,b){return e.PaginatedSubscription.isinstance(a)?this.spec.equals(a.spec)&&this.paginator.includes(a.paginator):b?void 0:a.includedIn(this,!0)},includedIn:function(a,b){return e.PaginatedSubscription.isinstance(a)?this.spec.equals(a.spec)&&this.paginator.includedIn(a.paginator):this.spec.includedIn(a)?!0:b?void 0:a.includes(this,!0)},decorate:function(a){return new e.PaginatedSubscription(this.paginator,this.resource,a)},toString:function(){return"{ "+this.spec.toString()+" }["+this.paginator.toString()+"]"}}),d.fromJSONHandlers.push(function(a,b){if(b.paginate){var c=e.fromJSON(b.paginate),f=d.fromJSON(a,b.values);return c?new e.PaginatedSubscription(c,a,f):(console.log("Paginator not supported:",b.paginate),f)}}),d.implement({slice:function(a,b){var c=new e(a,b),d=this;return new e.PaginatedSubscription(c,this.resource,d)}}),e}),a("sub-sync",["./lib/resource","./lib/filter","./lib/subscribable","./lib/subscriptionSpec","./lib/sort","./lib/paginator"],function(a,b,c,d,e,f){return{Filter:b,Subscribable:c,SubscriptionSpec:d,Resource:a,Sort:e,Paginator:f}})});